<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test SignalR - FunkoApi</title>
    <!-- Bootstrap para estilos r√°pidos -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Librer√≠a Cliente de SignalR (Microsoft oficial) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
</head>
<body class="bg-light p-4">

    <div class="container" style="max-width: 800px;">
        <h2 class="mb-4">üì° Monitor de Eventos FunkoApi</h2>

        <!-- Configuraci√≥n de Conexi√≥n -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">Configuraci√≥n</div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">URL del Hub:</label>
                    <input type="text" id="hubUrl" class="form-control" value="https://localhost:TU_PUERTO/ws/funkos">
                    <div class="form-text">Aseg√∫rate de poner el puerto correcto de tu API (ej: 5001, 7123).</div>
                </div>
                
                <div class="d-grid gap-2">
                    <button id="btnConnect" class="btn btn-success">Conectar WebSocket</button>
                    <button id="btnDisconnect" class="btn btn-danger" disabled>Desconectar</button>
                </div>
                
                <div class="mt-3">
                    <strong>Estado: </strong> <span id="status" class="badge bg-secondary">Desconectado</span>
                </div>
            </div>
        </div>

        <!-- Log de Eventos -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>üîî Eventos en Tiempo Real</span>
                <button onclick="clearLogs()" class="btn btn-sm btn-outline-secondary">Limpiar</button>
            </div>
            <div class="card-body bg-dark text-warning font-monospace" style="height: 400px; overflow-y: auto;" id="logs">
                <p class="text-muted">// Esperando conexi√≥n...</p>
            </div>
        </div>
    </div>

    <script>
        let connection = null;
        const btnConnect = document.getElementById("btnConnect");
        const btnDisconnect = document.getElementById("btnDisconnect");
        const statusSpan = document.getElementById("status");
        const logContainer = document.getElementById("logs");

        // Funci√≥n para conectar
        async function connect() {
            const url = document.getElementById("hubUrl").value;

            // 1. Crear la conexi√≥n con el Builder
            connection = new signalR.HubConnectionBuilder()
                .withUrl(url)
                .withAutomaticReconnect() // Reintentar si se cae la red
                .build();

            // 2. Definir los "Listeners" (Escuchadores de eventos)
            // Estos nombres DEBEN COINCIDIR con los que pusiste en FunkoService.cs
            
            // Evento CREAR
            connection.on("FunkoCreated", (data) => {
                logEvent("üü¢ NUEVO FUNKO CREADO", data);
            });

            // Evento ACTUALIZAR
            connection.on("FunkoUpdated", (data) => {
                logEvent("üü° FUNKO ACTUALIZADO", data);
            });

            // Evento BORRAR (Aqu√≠ recibimos solo el ID o el objeto, seg√∫n tu implementaci√≥n)
            connection.on("FunkoDeleted", (id) => {
                logEvent("üî¥ FUNKO ELIMINADO", { id: id });
            });

            // 3. Iniciar la conexi√≥n
            try {
                await connection.start();
                updateUI(true);
                addLog("system", "‚úÖ Conexi√≥n establecida con √©xito.");
            } catch (err) {
                addLog("error", "‚ùå Error al conectar: " + err.toString());
                console.error(err);
            }
        }

        // Funci√≥n para desconectar
        async function disconnect() {
            if (connection) {
                await connection.stop();
                updateUI(false);
                addLog("system", "‚èπÔ∏è Desconectado.");
            }
        }

        // Helpers de UI
        btnConnect.addEventListener("click", connect);
        btnDisconnect.addEventListener("click", disconnect);

        function updateUI(isConnected) {
            btnConnect.disabled = isConnected;
            btnDisconnect.disabled = !isConnected;
            statusSpan.textContent = isConnected ? "Conectado" : "Desconectado";
            statusSpan.className = isConnected ? "badge bg-success" : "badge bg-secondary";
            document.getElementById("hubUrl").disabled = isConnected;
        }

        function logEvent(title, data) {
            const time = new Date().toLocaleTimeString();
            const json = JSON.stringify(data, null, 2);
            
            const html = `
                <div class="mb-3 border-bottom border-secondary pb-2">
                    <span class="text-white">[${time}]</span> <strong>${title}</strong><br>
                    <pre class="m-0">${json}</pre>
                </div>
            `;
            logContainer.innerHTML += html;
            logContainer.scrollTop = logContainer.scrollHeight; // Auto-scroll
        }

        function addLog(type, msg) {
            const color = type === 'error' ? 'text-danger' : 'text-muted';
            logContainer.innerHTML += `<div class="${color}">${msg}</div>`;
        }
        
        function clearLogs() {
            logContainer.innerHTML = '';
        }
    </script>
</body>
</html>