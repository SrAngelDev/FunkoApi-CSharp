meta {
  name: SignalR - Test Completo (Crear-Actualizar-Eliminar)
  type: http
  seq: 4
}

post {
  url: {{host}}/funkos
  body: json
  auth: bearer
}

auth:bearer {
  token: {{authToken}}
}

body:json {
  {
    "nombre": "Funko Ciclo Completo SignalR",
    "precio": 19.99,
    "categoriaId": "{{categoriaId}}"
  }
}

assert {
  res.status: eq 201
}

script:post-response {
  if (res.status === 201) {
    const funkoId = res.body.id;
    bru.setVar("cicloFunkoId", funkoId);
    
    console.log("üöÄ INICIO: Ciclo completo de SignalR");
    console.log("1Ô∏è‚É£ Funko creado (FunkoCreated):", funkoId);
    console.log("‚è≥ Esperando para actualizar...");
    
    // Actualizar despu√©s de 2 segundos
    setTimeout(async () => {
      const updateResponse = await fetch(`http://localhost:5000/api/funkos/${funkoId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${bru.getVar("authToken")}`
        },
        body: JSON.stringify({
          nombre: "Funko Actualizado SignalR",
          precio: 24.99,
          categoriaId: bru.getVar("categoriaId")
        })
      });
      
      if (updateResponse.ok) {
        console.log("2Ô∏è‚É£ Funko actualizado (FunkoUpdated):", funkoId);
        console.log("‚è≥ Esperando para eliminar...");
        
        // Eliminar despu√©s de 2 segundos m√°s
        setTimeout(async () => {
          const deleteResponse = await fetch(`http://localhost:5000/api/funkos/${funkoId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${bru.getVar("authToken")}`
            }
          });
          
          if (deleteResponse.status === 204) {
            console.log("3Ô∏è‚É£ Funko eliminado (FunkoDeleted):", funkoId);
            console.log("‚úÖ CICLO COMPLETO: El cliente SignalR deber√≠a haber recibido 3 eventos");
          }
        }, 2000);
      }
    }, 2000);
  }
}
